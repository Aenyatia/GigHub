@using Microsoft.AspNetCore.Identity

@if (User.Identity.IsAuthenticated)
{
	<form method="post">
		<ul class="navbar-nav">
			<li id="notifications" class="nav-item">
				<a href="#" class="nav-link">
					<i class="fas fa-bell"></i>
					<span class="badge badge-info js-notifications-count"></span>
				</a>
			</li>
			<li class="nav-item dropdown">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					Hello @User.Identity.Name
				</a>
				<div class="dropdown-menu" aria-labelledby="navbarDropdown">
					<a asp-controller="Gigs" asp-action="Mine" class="dropdown-item">My Upcoming gigs</a>
					<a asp-controller="Gigs" asp-action="Attending" class="dropdown-item">Gigs I'm Going</a>
					<a asp-controller="Users" asp-action="Following" class="dropdown-item">Artist I'm Following</a>
					<div class="dropdown-divider"></div>
					<button type="submit" asp-controller="Account" asp-action="Logout" class="dropdown-item">Sign out</button>
				</div>
			</li>
		</ul>
	</form>
}
else
{
	<ul class="navbar-nav">
		<li class="nav-item">
			<a asp-controller="Account" asp-action="Login" class="nav-link">
				<i class="fas fa-user"></i>
				Sign in
			</a>
		</li>
		<li class="nav-item">
			<a asp-controller="Account" asp-action="Register" class="nav-link">
				<i class="fas fa-user-plus"></i>
				Sign up
			</a>
		</li>
	</ul>
}

@section scripts
	{
	@if (User.Identity.IsAuthenticated)
	{
		<script type="text/x-template" id="notifications-template">
			<ul class="notificationss">
				<%
				_.each(notifications, function(notification){
				if(notification.type == 1)
				{%>
				<li><span class="highlight"><%= notification.gig.artist.name %></span> has canceled the gig at <%= notification.gig.venue %> at <%= moment(notification.gig.dateTime).format("D MMM HH:mm") %></li>
				<%}

				if(notification.type == 2)
				{
				var changes = [];
				var originalValues = [];
				var newValues = [];

				if(notification.originalVenue != notification.gig.venue)
				{
				changes.push('venue');
				originalValues.push(notification.originalVenue);
				newValues.push(notification.gig.venue);
				}

				if(notification.originalDateTime != notification.gig.dateTime)
				{
				changes.push('date/time');
				originalValues.push(moment(notification.originalDateTime).format("D MMM HH:mm"));
				newValues.push(moment(notification.gig.dateTime).format("D MMM HH:mm"));
				}

				%>
				<li><span class="highlight"><%= notification.gig.artist.name %></span> has changed the <%= changes.join(' and ') %> of the gig from <%= originalValues.join('') %> to <%= newValues.join('') %></li>
				<%}

				if(notification.type == 3)
				{%>
				<li><%= notification.gig.artist.name %> has created the gig.</li>
				<%}
				})
				%>
			</ul>
		</script>

		<script>
			$(document).ready(function () {
				$.ajax(
					{
						url: "/api/notifications",
						method: "GET",
						dataType: "json"
					})
					.done(function (notifications) {
						if (notifications.length === 0) {
							return;
						}

						$(".js-notifications-count")
							.css("display", "inline-block")
							.text(notifications.length)
							.addClass("animated bounceInDown");

						$("#notifications").popover({
							html: true,
							title: "Notifications",
							content: function () {
								var compiled = _.template($("#notifications-template").html());
								return compiled({ notifications: notifications });
							},
							placement: "bottom",
							trigger: "click",
							template: '<div class="popover popover-notifications" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>'

						}).on("shown.bs.popover", function () {
							$.ajax(
								{
									url: "/api/notifications",
									method: "POST"
								})
								.done(function () {
									$(".js-notifications-count")
										.css("display", "none")
										.text("");
								})
								.fail(function () {
									alert("Cant connect.");
								});
						});
					})
					.fail(function () {
						alert("Something failed!");
					});
			});
		</script>
	}
}
